<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.health.agent.module.knowledge.mapper.DocumentMapper">

    <resultMap id="DocumentResultMap" type="com.health.agent.module.knowledge.entity.Document">
        <id column="id" property="id"/>
        <result column="knowledge_base_id" property="knowledgeBaseId"/>
        <result column="filename" property="filename"/>
        <result column="content" property="content"/>
        <result column="chunks" property="chunks"/>
        <result column="vector_ids" property="vectorIds"/>
        <result column="status" property="status"/>
        <result column="uploaded_at" property="uploadedAt"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO document
        (knowledge_base_id, filename, content, chunks, vector_ids, status, uploaded_at)
        VALUES
        (#{knowledgeBaseId}, #{filename}, #{content}, #{chunks}, #{vectorIds}, #{status}, #{uploadedAt})
    </insert>

    <update id="update">
        UPDATE document
        <set>
            <if test="knowledgeBaseId != null">knowledge_base_id = #{knowledgeBaseId},</if>
            <if test="filename != null">filename = #{filename},</if>
            <if test="content != null">content = #{content},</if>
            <if test="chunks != null">chunks = #{chunks},</if>
            <if test="vectorIds != null">vector_ids = #{vectorIds},</if>
            <if test="status != null">status = #{status},</if>
        </set>
        WHERE id = #{id}
    </update>

    <select id="selectById" resultMap="DocumentResultMap">
        SELECT * FROM document WHERE id = #{id}
    </select>

    <select id="selectByKnowledgeBase" resultMap="DocumentResultMap">
        SELECT * FROM document
        WHERE knowledge_base_id = #{knowledgeBaseId}
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY uploaded_at DESC
    </select>

</mapper>

